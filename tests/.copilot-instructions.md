# Copilot Instructions â€” tests/

> These instructions supplement the root `.github/copilot-instructions.md` and apply to all test projects under `tests/`.

---

## Test Frameworks

This repository uses **two** test frameworks â€” use the correct one based on the test project type:

| Project Type | Framework | SDK | Attributes |
|---|---|---|---|
| **Unit tests** (Basket, Ordering, ClientApp) | **MSTest** | `MSTest.Sdk` | `[TestClass]`, `[TestMethod]`, `[DataTestMethod]`, `[DataRow]` |
| **Functional tests** (Catalog, Ordering) | **xUnit v3** | `Aspire.AppHost.Sdk` | `[Fact]`, `[Theory]`, `[InlineData]`, `[ClassData]` |

### âœ… DO

- Use **MSTest** (`[TestClass]`, `[TestMethod]`) for new unit test classes.
- Use **xUnit v3** (`[Fact]`, `[Theory]`) for new functional/integration test classes that require Aspire test containers.
- Match the framework used by the specific test project you're working in â€” check its `.csproj` SDK.

### ðŸš« DO NOT

- Never mix MSTest and xUnit in the same test project.
- Never suggest NUnit â€” it is not used in this repository.
- Never suggest Moq â€” this repository uses **NSubstitute**.

---

## Mocking Library â€” NSubstitute

- All mocking uses **NSubstitute** (`Substitute.For<T>()`).
- For ClientApp tests, hand-written mock classes are used instead (e.g., `MockSettingsService`, `MockOrderService`).

```csharp
// âœ… Correct â€” NSubstitute
var mockRepository = Substitute.For<IBasketRepository>();
mockRepository.GetBasketAsync("1").Returns(Task.FromResult(new CustomerBasket { BuyerId = "1" }));

// ðŸš« Wrong â€” Never use Moq
var mock = new Mock<IBasketRepository>();
```

---

## Test Naming

Follow the existing naming conventions per project:

- **Ordering unit tests**: Descriptive PascalCase â€” `Add_new_Order_raises_new_event()`, `Cancel_order_command_handler_sends_command()`
- **Basket unit tests**: Descriptive PascalCase â€” `GetBasketReturnsEmptyForNoUser()`, `GetBasketReturnsItemsForValidUserId()`
- **Functional tests** (xUnit): Descriptive PascalCase â€” `GetCatalogItemsRespectsPageSize()`, `GetAllStoredOrdersWorks()`
- **ClientApp tests**: PascalCase with suffix â€” `BasketViewModelAddItemTest()`, `OrderViewModelOrderTest()`

---

## Test Structure â€” Arrange-Act-Assert

All tests must follow the **Arrange-Act-Assert** pattern:

```csharp
[TestMethod]
public async Task GetBasketReturnsEmptyForNoUser()
{
    // Arrange
    var mockRepository = Substitute.For<IBasketRepository>();
    var service = new BasketService(mockRepository, NullLogger<BasketService>.Instance);
    
    // Act
    var response = await service.GetBasket(new GetBasketRequest(), serverCallContext);
    
    // Assert
    Assert.IsInstanceOfType<CustomerBasketResponse>(response);
    Assert.IsEmpty(response.Items);
}
```

---

## Assertion Patterns

### MSTest Assertions (unit tests)

```csharp
Assert.IsNotNull(result);
Assert.AreEqual(expected, actual);
Assert.IsTrue(condition);
Assert.IsFalse(condition);
Assert.IsInstanceOfType<ExpectedType>(obj);
Assert.IsEmpty(collection);
Assert.HasCount(expectedCount, collection);
Assert.ThrowsException<ExpectedException>(() => action());
await Assert.ThrowsExceptionAsync<ExpectedException>(async () => await asyncAction());
```

### xUnit Assertions (functional tests)

```csharp
Assert.Equal(expected, actual);
Assert.NotNull(result);
Assert.True(condition);
Assert.NotEmpty(collection);
response.EnsureSuccessStatusCode();
```

---

## Functional Test Infrastructure

Functional tests use **Aspire test containers** with real PostgreSQL databases:

- Test fixtures extend `WebApplicationFactory<Program>` and implement `IAsyncLifetime`.
- PostgreSQL is provisioned via `DistributedApplication.CreateBuilder` â†’ `AddPostgres(...)`.
- Connection strings are injected via `IHostBuilder.ConfigureHostConfiguration` with `AddInMemoryCollection`.
- Authentication is bypassed using `AutoAuthorizeMiddleware` registered via `IStartupFilter`.
- API versioning is handled with `ApiVersionHandler` + `QueryStringApiVersionWriter`.

### âœ… DO

- Reuse existing fixture patterns (`CatalogApiFixture`, `OrderingApiFixture`) for new functional tests.
- Use `TestContext.Current.CancellationToken` (xUnit) or `TestContext.CancellationToken` (MSTest) for async test cancellation.
- Test across API versions using `[Theory] + [InlineData(1.0)] + [InlineData(2.0)]`.

### ðŸš« DO NOT

- Never start real application hosts or Docker containers manually in tests â€” use the Aspire fixture pattern.
- Never hard-code connection strings in tests.

---

## Test Builders

Use existing builder patterns for test data:

```csharp
// Ordering domain test builders
var address = new AddressBuilder().Build();
var order = new OrderBuilder(address)
    .AddOne(productId: 1, productName: "Product", unitPrice: 10m, discount: 0m, pictureUrl: "", units: 1)
    .Build();
```

---

## Parallelization

- MSTest projects enable parallel execution: `[assembly: Parallelize(Workers = 0, Scope = ExecutionScope.MethodLevel)]`
- Ensure tests are isolated and do not share mutable state.

---

## Files to EXCLUDE

- Do **not** generate or modify test fixture infrastructure unless explicitly asked.
- Do **not** modify `Directory.Build.props` in the tests folder unless asked about test configuration.
